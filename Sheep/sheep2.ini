<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ewe Care - Sheep Health Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            background-color: #f0f2f5;
            color: #333;
        }
        .header-section {
            background-color: #fff;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .main-container {
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .hidden {
            display: none;
        }
        .status-healthy {
            color: #28a745;
            font-weight: bold;
        }
        .status-sick {
            color: #dc3545;
            font-weight: bold;
        }
        .status-treatment {
            color: #ffc107;
            font-weight: bold;
        }
        .loading {
            font-style: italic;
            color: #6c757d;
        }
        .nav-link.active {
            font-weight: bold;
            color: #007bff !important;
        }
    </style>
</head>
<body>

    <header class="header-section text-center">
        <h1 class="display-4 text-primary">🐏 Ewe Care</h1>
        <p class="lead text-muted">A simple application to track the health of your flock.</p>
    </header>

    <div class="container main-container">
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link active" href="#" onclick="showSection('home')">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('records')">Records</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('analytics')">Analytics</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('reminders')">Reminders</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('settings')">Settings</a>
            </li>
        </ul>

        <div id="homeSection">
            <h2 class="mb-4">Add New Health Record</h2>
            <form id="sheepHealthForm">
                <div class="mb-3">
                    <label for="sheepId" class="form-label">Sheep ID</label>
                    <input type="text" class="form-control" id="sheepId" required>
                </div>
                <div class="mb-3">
                    <label for="healthStatus" class="form-label">Health Status</label>
                    <select class="form-select" id="healthStatus" required>
                        <option value="Healthy">Healthy</option>
                        <option value="Sick">Sick</option>
                        <option value="Under Treatment">Under Treatment</option>
                        <option value="Recovering">Recovering</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="dateRecorded" class="form-label">Date Recorded</label>
                    <input type="date" class="form-control" id="dateRecorded" required>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="weight" class="form-label">Weight (kg)</label>
                        <input type="number" step="0.1" class="form-control" id="weight">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="temperature" class="form-label">Temperature (°C)</label>
                        <input type="number" step="0.1" class="form-control" id="temperature">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="notes" class="form-label">Notes</label>
                    <textarea class="form-control" id="notes" rows="3"></textarea>
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">Reset</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Add Record</button>
                </div>
            </form>
        </div>

        <div id="recordsSection" class="hidden">
            <h2 class="mb-4">All Health Records</h2>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="input-group w-50">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" onkeyup="filterRecords()" placeholder="Search by Sheep ID...">
                </div>
                <button class="btn btn-outline-success" onclick="exportData()"><i class="fas fa-download"></i> Export CSV</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th>Sheep ID</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Weight</th>
                            <th>Temp</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sheepHealthTableBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="analyticsSection" class="hidden">
            <h2 class="mb-4">Analytics & Stats</h2>
            <div class="row text-center mb-4">
                <div class="col-md-3">
                    <div class="card p-3">
                        <h5 class="text-primary">Total Records</h5>
                        <h1 id="totalCount">0</h1>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3">
                        <h5 class="text-success">Healthy</h5>
                        <h1 id="healthyCount">0</h1>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3">
                        <h5 class="text-danger">Sick</h5>
                        <h1 id="sickCount">0</h1>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3">
                        <h5 class="text-warning">Under Treatment</h5>
                        <h1 id="treatmentCount">0</h1>
                    </div>
                </div>
            </div>
            <h4>Recent Activity</h4>
            <div id="recentActivity" class="bg-light p-3 rounded">
                </div>
        </div>

                <div id="remindersSection" class="hidden">
            <h2 class="mb-4">🐑 Health Reminders & Schedule</h2>
            <div class="card p-4 mb-4">
                <h4 class="mb-3">Add New Reminder</h4>
                <form id="reminderForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="reminderSheepId" class="form-label">Sheep ID</label>
                            <input type="text" class="form-control" id="reminderSheepId" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="reminderDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="reminderDate" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="reminderType" class="form-label">Event Type</label>
                        <select class="form-select" id="reminderType" required>
                            <option value="Deworming">Deworming</option>
                            <option value="Vaccination">Vaccination</option>
                            <option value="Health Check">Weekly Health Check</option>
                            <option value="Growth Plan">Growth Plan Check</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="reminderNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="reminderNotes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-calendar-plus"></i> Save Reminder</button>
                </form>
            </div>

            <div class="card p-4">
                <h4 class="mb-3">Upcoming Reminders</h4>
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th>Sheep ID</th>
                                <th>Date</th>
                                <th>Event</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="remindersTableBody">
                            <tr><td colspan="5" class="text-center loading">Loading reminders...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="settingsSection" class="hidden">
            <h2 class="mb-4">Settings</h2>
            <div class="card p-4">
                <h4>Firebase Connection Status</h4>
                <p>Test the connection to your Firebase database.</p>
                <div class="d-flex align-items-center mb-3">
                    <span class="badge bg-secondary me-2" id="connectionStatus">Not Tested</span>
                    <button class="btn btn-sm btn-outline-info" onclick="testConnection()">Test Connection</button>
                </div>
                <p class="text-muted small">If the connection fails, check your Firebase config and security rules.</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>

    <script>
        //<![CDATA[
        // ✅ Your Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBdiEUorFPkiZAya84Xzx17id82nB77Zg4",
            authDomain: "sheep-1b6a7.firebaseapp.com",
            databaseURL: "https://sheep-1b6a7-default-rtdb.firebaseio.com",
            projectId: "sheep-1b6a7",
            storageBucket: "sheep-1b6a7.firebasestorage.app",
            messagingSenderId: "243565434909",
            appId: "1:243565434909:web:25312f89033e3fd0d54ef4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const sheepHealthForm = document.getElementById('sheepHealthForm');
        const sheepHealthTableBody = document.getElementById('sheepHealthTableBody');
        const reminderForm = document.getElementById('reminderForm');
        const remindersTableBody = document.getElementById('remindersTableBody');

        let allRecords = [];
        let allReminders = [];

        // Set today's date as default
        document.getElementById('dateRecorded').valueAsDate = new Date();

        // Navigation between sections
        function showSection(sectionName) {
            const sections = ['homeSection', 'recordsSection', 'analyticsSection', 'remindersSection', 'settingsSection'];
            sections.forEach(section => {
                document.getElementById(section).classList.add('hidden');
            });
            document.getElementById(sectionName + 'Section').classList.remove('hidden');

            // Handle active nav link
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`.nav-link[onclick="showSection('${sectionName}')"]`).classList.add('active');


            if (sectionName === 'records') {
                fetchHealthRecords();
            } else if (sectionName === 'analytics') {
                updateAnalytics();
            } else if (sectionName === 'reminders') {
                fetchReminders();
            } else if (sectionName === 'settings') {
                checkConnectionStatus();
            }
        }

        // ✅ Fetch records from Realtime Database
        function fetchHealthRecords() {
            sheepHealthTableBody.innerHTML = '<tr><td colspan="7" class="text-center loading">Loading records...</td></tr>';
            const recordsRef = db.ref("sheepHealthRecords").orderByChild("dateRecorded");

            recordsRef.once("value", (snapshot) => {
                allRecords = [];
                if (!snapshot.exists()) {
                    sheepHealthTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No sheep health records found. Add your first record!</td></tr>';
                    return;
                }

                sheepHealthTableBody.innerHTML = '';
                snapshot.forEach(childSnapshot => {
                    const record = { id: childSnapshot.key, ...childSnapshot.val() };
                    allRecords.push(record);
                    addRecordToTable(record);
                });

                // Reverse the order for most recent records first
                allRecords.reverse();
                sheepHealthTableBody.innerHTML = '';
                allRecords.forEach(record => addRecordToTable(record));

                updateStats();
            }, (error) => {
                sheepHealthTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading records: ' + error.message + '</td></tr>';
                console.error(error);
            });
        }

        function addRecordToTable(record) {
            const statusClass = getStatusClass(record.healthStatus);
            const row = `
                <tr>
                    <td><strong>${record.sheepId}</strong></td>
                    <td><span class="${statusClass}">${record.healthStatus}</span></td>
                    <td>${record.dateRecorded || 'N/A'}</td>
                    <td>${record.weight || 'N/A'}</td>
                    <td>${record.temperature || 'N/A'}</td>
                    <td>${record.notes || 'No notes'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('${record.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            sheepHealthTableBody.innerHTML += row;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'Healthy': return 'status-healthy';
                case 'Sick': return 'status-sick';
                case 'Under Treatment': case 'Recovering': return 'status-treatment';
                default: return '';
            }
        }

        // Update statistics
        function updateStats() {
            const healthy = allRecords.filter(r => r.healthStatus === 'Healthy').length;
            const sick = allRecords.filter(r => r.healthStatus === 'Sick').length;
            const treatment = allRecords.filter(r => r.healthStatus === 'Under Treatment' || r.healthStatus === 'Recovering').length;

            document.getElementById('healthyCount').textContent = healthy;
            document.getElementById('sickCount').textContent = sick;
            document.getElementById('treatmentCount').textContent = treatment;
            document.getElementById('totalCount').textContent = allRecords.length;
        }

        // ✅ Add new record to Realtime Database
        function handleFormSubmit(e) {
            e.preventDefault();
            const sheepId = document.getElementById('sheepId').value.trim();
            const healthStatus = document.getElementById('healthStatus').value;
            const dateRecorded = document.getElementById('dateRecorded').value;
            const weight = document.getElementById('weight').value;
            const temperature = document.getElementById('temperature').value;
            const notes = document.getElementById('notes').value.trim();

            if (!sheepId || !healthStatus || !dateRecorded) {
                alert('Please fill out Sheep ID, Health Status, and Date.');
                return;
            }

            const record = {
                sheepId,
                healthStatus,
                dateRecorded,
                notes,
                timestamp: new Date().toISOString()
            };

            if (weight) record.weight = parseFloat(weight);
            if (temperature) record.temperature = parseFloat(temperature);

            db.ref("sheepHealthRecords").push(record)
                .then(() => {
                    // Show success message
                    const submitBtn = document.querySelector('#sheepHealthForm button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> Record Added!';
                    submitBtn.classList.add('btn-success');
                    submitBtn.classList.remove('btn-primary');

                    setTimeout(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.classList.add('btn-primary');
                        submitBtn.classList.remove('btn-success');
                    }, 2000);

                    sheepHealthForm.reset();
                    document.getElementById('dateRecorded').valueAsDate = new Date();
                    fetchHealthRecords();
                })
                .catch((error) => {
                    alert('Error adding record: ' + error.message);
                    console.error(error);
                });
        }

        // Delete record
        function deleteRecord(recordId) {
            if (confirm('Are you sure you want to delete this record?')) {
                db.ref(`sheepHealthRecords/${recordId}`).remove()
                    .then(() => {
                        fetchHealthRecords();
                    })
                    .catch((error) => {
                        alert('Error deleting record: ' + error.message);
                        console.error(error);
                    });
            }
        }

        // Search/Filter records
        function filterRecords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = sheepHealthTableBody.querySelectorAll('tr');

            rows.forEach(row => {
                const sheepId = row.cells[0]?.textContent.toLowerCase() || '';
                if (sheepId.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Reset form
        function resetForm() {
            sheepHealthForm.reset();
            document.getElementById('dateRecorded').valueAsDate = new Date();
        }

        // Export data
        function exportData() {
            if (allRecords.length === 0) {
                alert('No data to export');
                return;
            }

            const csv = convertToCSV(allRecords);
            downloadCSV(csv, 'sheep_health_records.csv');
        }

        function convertToCSV(data) {
            const header = 'Sheep ID,Health Status,Date Recorded,Weight,Temperature,Notes\n';
            const rows = data.map(record =>
                `${record.sheepId},${record.healthStatus},${record.dateRecorded || ''},${record.weight || ''},${record.temperature || ''},"${record.notes || ''}"`
            ).join('\n');
            return header + rows;
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Analytics
        function updateAnalytics() {
            // Simple analytics without external chart library
            const statusCounts = {
                'Healthy': allRecords.filter(r => r.healthStatus === 'Healthy').length,
                'Sick': allRecords.filter(r => r.healthStatus === 'Sick').length,
                'Under Treatment': allRecords.filter(r => r.healthStatus === 'Under Treatment').length,
                'Recovering': allRecords.filter(r => r.healthStatus === 'Recovering').length
            };

            // Update recent activity
            const recentRecords = allRecords.slice(0, 5);
            const activityHtml = recentRecords.map(record =>
                `<div class="border-bottom py-2">
                    <strong>${record.sheepId}</strong> - ${record.healthStatus}
                    <small class="text-muted d-block">${record.dateRecorded}</small>
                </div>`
            ).join('');

            document.getElementById('recentActivity').innerHTML = activityHtml || '<p class="text-muted">No recent activity</p>';
        }

        // ✅ New Function to Fetch Reminders
        function fetchReminders() {
            remindersTableBody.innerHTML = '<tr><td colspan="5" class="text-center loading">Loading reminders...</td></tr>';
            const remindersRef = db.ref("sheepReminders").orderByChild("date");

            remindersRef.once("value", (snapshot) => {
                allReminders = [];
                if (!snapshot.exists()) {
                    remindersTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No upcoming reminders.</td></tr>';
                    return;
                }

                remindersTableBody.innerHTML = '';
                snapshot.forEach(childSnapshot => {
                    const reminder = { id: childSnapshot.key, ...childSnapshot.val() };
                    allReminders.push(reminder);
                    addReminderToTable(reminder);
                });
            }, (error) => {
                remindersTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading reminders: ' + error.message + '</td></tr>';
                console.error(error);
            });
        }

        function addReminderToTable(reminder) {
            const row = `
                <tr>
                    <td><strong>${reminder.sheepId}</strong></td>
                    <td>${reminder.date}</td>
                    <td>${reminder.type}</td>
                    <td>${reminder.notes || 'No notes'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteReminder('${reminder.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            remindersTableBody.innerHTML += row;
        }

        // ✅ New Function to Handle Form Submission
        function handleReminderFormSubmit(e) {
            e.preventDefault();
            const sheepId = document.getElementById('reminderSheepId').value.trim();
            const date = document.getElementById('reminderDate').value;
            const type = document.getElementById('reminderType').value;
            const notes = document.getElementById('reminderNotes').value.trim();

            if (!sheepId || !date || !type) {
                alert('Please fill out all required fields.');
                return;
            }

            const newReminder = {
                sheepId,
                date,
                type,
                notes,
                timestamp: new Date().toISOString()
            };

            db.ref("sheepReminders").push(newReminder)
                .then(() => {
                    alert('Reminder added successfully!');
                    reminderForm.reset();
                    fetchReminders();
                })
                .catch((error) => {
                    alert('Error adding reminder: ' + error.message);
                    console.error(error);
                });
        }

        // ✅ New Function to Delete Reminder
        function deleteReminder(reminderId) {
            if (confirm('Are you sure you want to delete this reminder?')) {
                db.ref(`sheepReminders/${reminderId}`).remove()
                    .then(() => {
                        fetchReminders();
                    })
                    .catch((error) => {
                        alert('Error deleting reminder: ' + error.message);
                        console.error(error);
                    });
            }
        }

        // Connection test
        function checkConnectionStatus() {
            testConnection();
        }

        function testConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.textContent = 'Testing...';
            statusDiv.className = 'badge bg-warning';

            // Test connection by reading a single record
            db.ref("sheepHealthRecords").limitToFirst(1).once("value")
                .then(() => {
                    statusDiv.textContent = 'Connected';
                    statusDiv.className = 'badge bg-success';
                })
                .catch((error) => {
                    statusDiv.textContent = 'Connection Failed';
                    statusDiv.className = 'badge bg-danger';
                    console.error('Connection test failed:', error);
                });
        }

        // Event listeners
        sheepHealthForm.addEventListener('submit', handleFormSubmit);
        reminderForm.addEventListener('submit', handleReminderFormSubmit);

        // Initialize
        showSection('home');
        //]]>
    </script>
</body>
</html>